# AutoFlow System Architecture

```mermaid
graph TD
    User([Customer (WhatsApp)])
    WebVisitor([Website Visitor])
    Admin([Admin / Business Owner])
    WA_Servers[WhatsApp Servers]
    Google_AI[Google Gemini AI]
    Google_Sheets[Google Sheets (DB)]

    subgraph Frontend_React_Vite["Frontend (React + Vite)"]
        direction TB
        subgraph Public_Facing["Public Facing"]
            Landing_Page[Landing Page]
            Hero[Hero Section]
            Navbar[Navigation Navbar]
        end
        
        subgraph App_Dashboard["App / Dashboard"]
            UI_Auth[Auth / Login]
            UI_Builder[Logic Builder (ReactFlow)]
            UI_Deploy[Deployment Manager]
            UI_Dashboard[ROI Dashboard]
            UI_Sim[Simulator]
        end
    end

    subgraph Backend_Node_Express["Backend (Node.js + Express)"]
        API[API Routes (/api)]
        
        subgraph Controllers["Controllers"]
            Ctrl_WA[WhatsApp Controller]
            Ctrl_WF[Workflow Controller]
        end
        
        subgraph Core_Services["Core Services"]
            Svc_WA[WhatsApp Service (Baileys)]
            Svc_Engine[Logic Engine]
            Svc_AI[AI Service]
            Svc_Sheets[Google Sheet Service]
        end
        
        Session_Store[Local Session Store]
    end

    User -->|E2E Encrypted| WA_Servers
    WebVisitor -->|Visits| Landing_Page
    Landing_Page --> Navbar
    Landing_Page --> Hero
    Navbar -->|Login| UI_Auth
    UI_Auth --> UI_Dashboard
    
    Admin -->|HTTP / WebSocket| UI_Dashboard
    Admin -->|Interacts| UI_Builder

    UI_Deploy -->|POST /whatsapp/deploy| API
    UI_Sim -->|POST /simulate-message| API
    UI_Builder -->|POST /generate-workflow| API

    API --> Ctrl_WA
    API --> Ctrl_WF
    
    Ctrl_WA --> Svc_WA
    Ctrl_WF --> Svc_AI

    Svc_WA -->|WebSocket| WA_Servers
    Svc_WA -->|Persist Auth| Session_Store
    Svc_WA -->|Incoming Msg| Svc_Engine
    Svc_Engine -->|Reply| Svc_WA

    Svc_Engine -->|Read/Write| Svc_Sheets
    Svc_Engine -.->|AI Logic| Svc_AI
    
    Svc_Sheets -->|REST API| Google_Sheets
    Svc_AI -->|REST API| Google_AI
```



## 3. Component Breakdown

### A. Frontend Layer (React)
- **Landing Page Module (`src/components/landing`)**:
    - **Hero Section**: High-conversion entry point with 3D animations and typed text effects.
    - **Navbar**: Responsive navigation with mobile menu support.
    - **Features/Comparison**: Showcases the value prop against traditional methods.
- **Deployment Manager (`DeployPage.jsx`)**: Handles the critical QR code handshake. It polls the backend status and renders the QR code generated by the Baileys library.
- **Logic Builder (`Builder.jsx`)**: Uses `ReactFlow` to visualize conversation nodes. It communicates with the **AI Service** to generate workflows from natural language prompts.
- **Simulator (`TestMode.jsx`)**: Allows testing the agent without a real WhatsApp connection. It sends messages directly to the `Logic Engine` via the `/simulate-message` endpoint.

### B. Backend Layer (Node.js/Express)
- **WhatsApp Service (`whatsapp.service.js`)**: The core communication layer. It uses `@whiskeysockets/baileys` to emulate a browser-based WhatsApp Web client. It manages the WebSocket connection, handles encryption, and emits events for incoming messages.
- **Logic Engine (`engine.service.js`)**: The brain of the bot. Currently, it uses a **hybrid approach**:
    - **Rule-Based**: High-speed regex matching for common intents (Store hours, greetings).
    - **Data-Driven**: Queries Google Sheets for dynamic data (Product lookup, Order tracking).
- **Google Sheet Service (`googleSheet.service.js`)**: Acts as the database.
    - **Inventory Sync**: Reads product data (Stock, Price) in real-time.
    - **Order Logging**: Appends new rows for incoming orders with IDs and timestamps.
- **AI Service (`ai.service.js`)**:
    - **Generation**: specific prompt engineering to convert user descriptions (e.g., "Shoe store agent") into structured JSON workflows.
    - **Explanation**: Converts JSON workflows back into human-readable summaries.

### C. Data Persistence
- **Google Sheets**: Serves as a lightweight, user-accessible CMS/Database. Users can manage inventory directly in Sheets, and the bot reflects changes immediately.
- **Local Filesystem**: Used for storing WhatsApp Session credentials (`auth_info_baileys`). This ensures the bot stays logged in across server restarts.

---

## 4. Key Workflows

### 1. Agent Deployment
1. Admin visits **Deploy Page**.
2. Frontend requests QR code from Backend.
3. **WhatsApp Service** establishes WebSocket with WhatsApp Servers.
4. User scans QR code.
5. Session credentials are saved locally.
6. Connection is established ("Open" state).

### 2. Message Processing Loop
1. **User** sends "Do you have Nike shoes?" on WhatsApp.
2. **WhatsApp Service** receives encrypted payload, decrypts it, and extracts text.
3. **Logic Engine** analyzes text:
   - Detects keyword "Nike".
   - Identifies intent: `product_inquiry`.
4. **Google Sheet Service** is called to search "Nike" in the Inventory Sheet.
5. Returns: `{ found: true, stock: 5, price: 5000 }`.
6. **Logic Engine** formats response: "Yes! We have Nike shoes in stock..."
7. **WhatsApp Service** sends reply to User.
